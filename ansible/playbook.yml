---
- name: Setup Next.js Application on AWS EC2
  hosts: nextjs
  become: yes

  vars:
    app_name: bnoverseas-app
    app_port: 3000
    app_user: ubuntu
    app_group: ubuntu
    node_version: "20"
    repo_url: "https://github.com/abhishek1621-code/overseas-site.git"
    app_directory: "/var/www/{{ app_name }}"
    domain_name: "{{ ansible_host }}"  # EC2 public IP

  tasks:
    # Step 1: System Updates
    - name: Update package manager cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Upgrade all packages
      apt:
        upgrade: dist

    - name: Install basic dependencies
      apt:
        name:
          - curl
          - wget
          - git
          - build-essential
          - ufw
          - htop
          - nano
          - net-tools
          - python3-pip
        state: present

    # Step 2: Install Node.js
    - name: Check if NodeSource repository is already installed
      stat:
        path: /etc/apt/sources.list.d/nodesource.list
      register: nodesource_repo

    - name: Add Node.js repository
      shell: curl -fsSL https://deb.nodesource.com/setup_{{ node_version }}.x | bash -
      when: not nodesource_repo.stat.exists

    - name: Install Node.js and npm
      apt:
        name: nodejs
        state: present
        update_cache: yes

    - name: Verify Node.js installation
      shell: node -v && npm -v
      register: node_version_check
      changed_when: false

    - name: Display Node.js and npm version
      debug:
        msg: "{{ node_version_check.stdout }}"

    # Step 3: Install and Start Nginx
    - name: Install Nginx
      apt:
        name: nginx
        state: present

    - name: Start Nginx service
      systemd:
        name: nginx
        enabled: yes
        state: started

    # Step 4: Configure Firewall
    - name: Enable UFW firewall
      ufw:
        state: enabled
      ignore_errors: yes

    - name: Allow HTTP, HTTPS, and SSH
      ufw:
        rule: allow
        port: "{{ item }}"
        proto: tcp
      loop:
        - "22"
        - "80"
        - "443"
      ignore_errors: yes

    # Step 5: Clone Repository
    - name: Create app directory
      file:
        path: "{{ app_directory }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        mode: '0755'

    - name: Clone Next.js repository
      git:
        repo: "{{ repo_url }}"
        dest: "{{ app_directory }}"
        version: main
      become_user: "{{ app_user }}"

    # Step 6: Install Dependencies and Build
    - name: Install npm dependencies with legacy peer deps
      shell: |
        cd {{ app_directory }}
        npm install --legacy-peer-deps
      become_user: "{{ app_user }}"
      register: npm_install_result
      failed_when: npm_install_result.rc not in [0]

    - name: Build Next.js application
      shell: |
        cd {{ app_directory }}
        npm run build
      become_user: "{{ app_user }}"
      environment:
        NODE_ENV: production
      register: build_result
      failed_when: build_result.rc not in [0]

    # Step 7: Install and Start with PM2
    - name: Install PM2 globally
      npm:
        name: pm2
        global: yes

    - name: Start application with PM2
      shell: |
        cd {{ app_directory }}
        pm2 start npm --name "{{ app_name }}" -- start || true
      become_user: "{{ app_user }}"
      register: pm2_start_result
      changed_when: '"started" in pm2_start_result.stdout or "already running" in pm2_start_result.stdout'

    - name: Setup PM2 to start on boot
      shell: |
        pm2 startup systemd -u {{ app_user }} --hp /home/{{ app_user }} > /dev/null 2>&1 || true
        pm2 save
      become_user: "{{ app_user }}"
      register: pm2_startup_result
      changed_when: false

    # Step 8: Configure Nginx Reverse Proxy
    - name: Create Nginx configuration for reverse proxy
      copy:
        dest: /etc/nginx/sites-available/nextjs
        content: |
          server {
            listen 80;
            server_name {{ domain_name }} _;
            
            # Security headers
            add_header X-Frame-Options "SAMEORIGIN" always;
            add_header X-Content-Type-Options "nosniff" always;
            add_header X-XSS-Protection "1; mode=block" always;
            
            location / {
              proxy_pass http://127.0.0.1:{{ app_port }};
              proxy_http_version 1.1;
              proxy_set_header Upgrade $http_upgrade;
              proxy_set_header Connection 'upgrade';
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
              proxy_cache_bypass $http_upgrade;
              proxy_redirect off;
            }
          }
        owner: root
        group: root
        mode: '0644'

    - name: Check Nginx configuration
      shell: nginx -t
      register: nginx_test
      changed_when: false
      failed_when: nginx_test.rc != 0

    - name: Enable Nginx site configuration
      file:
        src: /etc/nginx/sites-available/nextjs
        dest: /etc/nginx/sites-enabled/nextjs
        state: link

    - name: Disable default Nginx site
      file:
        path: /etc/nginx/sites-enabled/default
        state: absent

    - name: Reload Nginx
      systemd:
        name: nginx
        state: reloaded

    # Step 9: Display deployment summary
    - name: Display deployment summary
      debug:
        msg:
          - "âœ… Next.js App Deployed Successfully!"
          - "Access it at: http://{{ domain_name }}/"
          - "PM2 app name: {{ app_name }}"
          - "Application port: {{ app_port }}"
          - "To check app status, SSH into the instance and run: pm2 status"
          - "To view logs: pm2 logs {{ app_name }}"
